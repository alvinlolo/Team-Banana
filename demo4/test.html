<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Example</title>
        <script src="comments.js" charset="utf-8"></script>
        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="css/style.css" media="screen" />
        <link rel="manifest" href="manifest.json">

    </head>
    <body>
        <script type="text/javascript">
            window.onbeforeunload = function () {
              window.scrollTo(0,0);
            }

        </script>

        <div class="video-container">
            <div id="heading">Cruise Ship does Damage</div>
            <video id="vid" src="sample2.m4v" autoplay poster="posterimage.png" width="100%">
            </video>
            <div id="heatmap">
                <div class="play-container">
                    <button type="button" class="play" id="play-pause"></button>
                </div>
                <div id="time-container">
                    <input type="range" id="time-control" value="0";>
                </div>
            </div>
        </div>

        

        <script type="text/javascript">
            function currentYPosition() {
                // Firefox, Chrome, Opera, Safari
                if (self.pageYOffset) return self.pageYOffset;
                // Internet Explorer 6 - standards mode
                if (document.documentElement && document.documentElement.scrollTop)
                    return document.documentElement.scrollTop;
                // Internet Explorer 6, 7 and 8
                if (document.body.scrollTop) return document.body.scrollTop;
                return 0;
            }

            function elmYPosition(eID) {
                var elm = document.getElementById(eID);
                var y = elm.offsetTop;
                var node = elm;
                while (node.offsetParent && node.offsetParent != document.body) {
                    node = node.offsetParent;
                    y += node.offsetTop;
                } return y;
            }

            function smoothScroll(eID) {
                var startY = currentYPosition();
                var stopY = elmYPosition(eID);
                var distance = stopY > startY ? stopY - startY : startY - stopY;
                if (distance < 100) {
                    scrollTo(0, stopY); return;
                }
                var speed = Math.round(distance / 100);
                if (speed >= 20) speed = 20;
                var step = Math.round(distance / 25);
                var leapY = stopY > startY ? startY + step : startY - step;
                var timer = 0;
                if (stopY > startY) {
                    for ( var i=startY; i<stopY; i+=step ) {
                        setTimeout("window.scrollTo(0, "+leapY+")", timer * speed);
                        leapY += step; if (leapY > stopY) leapY = stopY; timer++;
                    } return;
                }
                for ( var i=startY; i>stopY; i-=step ) {
                    setTimeout("window.scrollTo(0, "+leapY+")", timer * speed);
                    leapY -= step; if (leapY < stopY) leapY = stopY; timer++;
                }
                return false;
            }
        </script>

        <script type="text/javascript">
            document.addEventListener('touchstart', handleTouchStart, false);
            document.addEventListener('touchmove', handleTouchMove, false);

            var xDown = null;
            var yDown = null;

            function handleTouchStart(evt) {
                xDown = evt.touches[0].clientX;
                yDown = evt.touches[0].clientY;
            };

            function handleTouchMove(evt) {
                if ( ! xDown || ! yDown ) {
                    return;
                }

                var xUp = evt.touches[0].clientX;
                var yUp = evt.touches[0].clientY;

                var xDiff = xDown - xUp;
                var yDiff = yDown - yUp;

                if ( Math.abs( xDiff ) > Math.abs( yDiff ) ) {/*most significant*/
                    if ( xDiff > 0 ) {
                        /* left swipe */
                    } else {
                        /* right swipe */
                    }
                } else {
                    if ( yDiff > 0 ) {
                        // window.scrollTo(0,document.body.scrollHeight);
                        smoothScroll("comments")
                        pause();
                    } else {
                        // window.scrollTo(0,0);
                        smoothScroll("vid")
                        play();
                    }
                }
                /* reset values */
                xDown = null;
                yDown = null;
            };

        </script>


        <script type="text/javascript">
            var vid = document.getElementById("vid");
            var playButton = document.getElementById("play-pause");
            var timeControl = document.getElementById("time-control");
            //current comment divs
            var current = [];
            //completed seconds
            var completed = [];
            var secondGap = 3; //how long to wait before a video is deleted
            

            


            //play and pause video
            playButton.onclick = vid.onclick = function() {
                {
                if (vid.paused == true) {
                    play();
                } else {
                    pause();
                }
            };

            //jump to time in video
            timeControl.onchange = function() {
                var time = vid.duration * (timeControl.value / 100);
                vid.currentTime = time;
            };

            timeControl.onmousedown = function() {
                vid.pause();
            };

            timeControl.onmouseup = function() {
                vid.play();
            };

            }

            vid.oncanplay = function() {
                drawGraph();    
            }


            vid.ontimeupdate = function() {
                var commentsDiv = document.getElementById("comments");
                var seconds = parseInt(vid.currentTime);
                //time control seeker value
                var controlValue = (100 / vid.duration) * vid.currentTime;

                timeControl.value = controlValue;

                for (var comment in current) {
                    console.log(current[comment][1]);
                    if(current[comment][1] < seconds - (vid.duration / 50) ||  current[comment][1] > seconds + (vid.duration / 50)){
                        commentsDiv.removeChild(current[comment][0]);
                        console.log(completed);
                        var jk = current[comment][1];
                        var index = completed.indexOf(jk);
                        if (index > -1) {
                            completed.splice(index, 1);
                        }
                        console.log(completed);
                        delete current[comment];

                    }
                }

                /*if (completed.indexOf(seconds) == -1){
                    completed.push(seconds);*/

                    for (var i = seconds - (vid.duration / 50); i < seconds + (vid.duration / 50); i++) {
                        i = Math.round(i);
                        console.log(i);
                        if (completed.indexOf(i) == -1) {
                           // console.log(comments[i]);
                            //console.log(completed);
                            if (comments[i] != undefined) {
                                for (var comment in comments[i]){
                                    var comment = comments[i][comment];
                                    var commentContainerDiv = document.createElement("div");
                                    var commentDiv = document.createElement("div");
                                    var voteDiv =  document.createElement("div");
                                    var upVoteDiv =  document.createElement("div");
                                    var downVoteDiv =  document.createElement("div");
                                    commentContainerDiv.className = "comment-container";
                                    commentDiv.className = "comment";
                                    voteDiv.className = "vote";
                                    upVoteDiv.className = "up-vote";
                                    downVoteDiv.className = "down-vote";
                                    commentDiv.appendChild(document.createTextNode(comment));
                                    voteDiv.appendChild(upVoteDiv);
                                    voteDiv.appendChild(document.createTextNode("0"));
                                    voteDiv.appendChild(downVoteDiv);
                                    // commentsDiv.appendChild(commentDiv);
                                    commentContainerDiv.appendChild(commentDiv);
                                    commentContainerDiv.appendChild(voteDiv);
                                    commentsDiv.insertBefore(commentContainerDiv, commentsDiv.firstChild);
                                    completed.push(i);
                                    current.push([commentContainerDiv, i]);
                                }
                            }
                        }
                    }

                    /*if(comments[seconds] != undefined){

                        for (var comment in comments[seconds]){
                            var comment = comments[seconds][comment];
                            var commentContainerDiv = document.createElement("div");
                            var commentDiv = document.createElement("div");
                            var voteDiv =  document.createElement("div");
                            var upVoteDiv =  document.createElement("div");
                            var downVoteDiv =  document.createElement("div");
                            commentContainerDiv.className = "comment-container";
                            commentDiv.className = "comment";
                            voteDiv.className = "vote";
                            upVoteDiv.className = "up-vote";
                            downVoteDiv.className = "down-vote";
                            commentDiv.appendChild(document.createTextNode(comment));
                            voteDiv.appendChild(upVoteDiv);
                            voteDiv.appendChild(document.createTextNode("0"));
                            voteDiv.appendChild(downVoteDiv);
                            // commentsDiv.appendChild(commentDiv);
                            commentContainerDiv.appendChild(commentDiv);
                            commentContainerDiv.appendChild(voteDiv);
                            commentsDiv.insertBefore(commentContainerDiv, commentsDiv.firstChild);
                            current.push([commentContainerDiv, seconds]);
                        }
                    }*/

                //}
            };



            function play() {
                vid.play();
                playButton.className="pause";
            }

            function pause() {
                vid.pause();
                playButton.className="play";
            }

            function drawGraph() {
                var timeDiv = document.getElementById("time-container");
                var previousSecond = 0;
                for (var i = 0; i < 50; i ++) {
                    var second =  Math.round((i+ 1) * (vid.duration / 50));
                    var height = 0;

                    //console.log(comments[0]);
                    for (commentTime in comments) {
                        if (commentTime >= previousSecond && commentTime < second) {
                            height = comments[commentTime].length * 20;
                        }
                    }

                    height += 'px';
                    previousSecond = second;
                    
                    var point = document.createElement("point");
                    //amount moved left needed so points are spaced out 
                    var left = ((i * 2) + 0.5) + '%';
                    point.className = "point";
                    point.style.height = height;
                    point.style.left = left;
                    timeDiv.appendChild(point);
                };
            }

        </script>

        <div id="comments">
            <div></div>
            <div class="comment-input">
                <form>
                    <input type="text" name="comment" placeholder="enter a comment">
                    <input type="submit" value="Send">
                </form>
            </div>
        </div>

    </body>
</html>
